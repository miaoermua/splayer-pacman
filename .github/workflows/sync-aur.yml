name: Sync to AUR

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  sync-aur:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH for AUR
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

      - name: Sync to AUR
        run: |
          # 获取当前版本号
          VERSION=$(grep "^pkgver=" PKGBUILD | cut -d'=' -f2)
          TIMESTAMP=$(date +%s)

          # 添加 AUR 服务器到 known_hosts
          mkdir -p ~/.ssh
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts

          # 克隆 AUR 仓库
          git clone ssh://aur@aur.archlinux.org/splayer.git

          # 复制文件到 AUR 目录
          cp PKGBUILD splayer/
          cp .SRCINFO splayer/
          cp .gitignore splayer/  # 如果有特定的 .gitignore 设置

          # 进入 AUR 目录
          cd splayer

          # 配置 git 用户信息
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          # 添加所有更改
          git add .

          # 提交更改，使用指定的格式
          git commit -m "sync: $VERSION-$TIMESTAMP"

          # 推送到 AUR
          git push